<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Line Chart</title>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
	
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<script>
		const COLORS = [
	      'rgb(75, 192, 192)', // green
	      'rgb(255, 159, 64)', // orange
	      'rgb(201, 203, 207)', // grey
	      'rgb(54, 162, 235)', // blue
	      'rgb(255, 99, 132)', // red
	      'rgb(153, 102, 255)', // purple
	      'rgb(255, 205, 86)', // yellow
		];
		const charts = [
			{ 
				title: 'Corona Infections absolute', 
				getValue: function(dayData) { return dayData.total_cases; },
				config: {},
			},
			{ 
				title: 'Corona Infections per 100k citizens', 
				getValue: function(dayData, citizens) { return dayData.total_cases/citizens*100000; },
				config: {},
			},
			{ 
				title: 'New Corona Infections per 100k citizens', 
				getValue: function(dayData, citizens, index) {
					return dayData.new_cases/citizens*100000;
				},
				config: {},
			},
			{ 
				title: 'Running Corona Infections per 100k citizens', 
				getValue: function(dayData, citizens, index) {
					var running = dayData.total_cases - dayData.total_recovered - dayData.total_deaths;
					return running/citizens*100000;
				},
				config: {},
			},
			{ 
				title: 'Total number of new tests (smoothed)', 
				getValue: function(dayData, citizens, index) {
					return dayData.new_tests_smoothed;
				},
				config: {},
			},
			{ 
				title: 'New tests per 100k citizens (smoothed)', 
				getValue: function(dayData, citizens, index) {
					return dayData.new_tests_smoothed/citizens*100000;
				},
				config: {},
			},
			
			{ 
				title: 'Running Corona Infections per new test (smoothed)', 
				getValue: function(dayData, citizens, index) {
					var running = dayData.total_cases - dayData.total_recovered - dayData.total_deaths;
					return running/dayData.new_tests_smoothed;
				},
				config: {},
			},
			{ 
				title: 'Tests per case', 
				getValue: function(dayData, citizens, index) {
					return dayData.tests_per_case;
				},
				config: {},
			},
			{ 
				title: 'Corona Deaths absolute', 
				getValue: function(dayData) { return dayData.total_deaths; },
				config: {},
			},
			{ 
				title: 'Corona Deaths per 100k citizens', 
				getValue: function(dayData, citizens) { return dayData.total_deaths/citizens*100000; },
				config: {},
			},
			{ 
				title: 'New Corona Deaths per 100k citizens', 
				getValue: function(dayData, citizens, index) {
					return dayData.new_deaths/citizens*100000;
				},
				config: {},
			},
		];
		const configTemplate = {
			type: 'line',
			data: {
				labels: [],
				datasets: []
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: '',
					fontSize: 18,
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true,
				},
				scales: {
					x: {
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Month',
						}
					},
					y: {
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value',
						}
					}
				}
			}
		};
		var covidWorldData = [];

		var clone = function(obj) {
			return JSON.parse(JSON.stringify(obj));
		};

		var initConfigs = function() {
			charts.forEach(function(chart) {
					var cfg = clone(configTemplate);
					cfg.options.title.text = chart.title;
					chart.config = cfg;
			});	
			// Get days from the first country (examplary for all other countries)
			covidWorldData[0].data.forEach(function(day) {
				charts.forEach(function(chart, index) {
					chart.config.data.labels.push(day.date);
				});
			});
		};

		var addCountry = function(countryData, color) {
			var name = countryData.location;
			var citizens = countryData.population;
			charts.forEach(function(chart, index) {
				var ds = {
					label: name,
					backgroundColor: color,
					borderColor: color,
					data: [],
					fill: false,
				};
				countryData.data.forEach(function(dayData, index) {
					ds.data.push(chart.getValue(dayData, citizens, index));
				});
				chart.config.data.datasets.push(ds);
			});
		};

		window.onload = function() {
			$.getJSON('https://raw.githubusercontent.com/aweisser/corona-charts/master/data.json',
			function(owidCovidJson) {
				covidWorldData = owidCovidJson;
				initConfigs();
				covidWorldData.forEach(function(countryData, index) {
					addCountry(countryData, COLORS[index]);
				});

				charts.forEach(function(chart, index) {
					var canvasId = "canvas"+index;
					$("body").append($([
						"<div style='width:75%;'>",
						"	<canvas id='"+canvasId+"'></canvas>",
						"</div>",
						"<br>",
						"<br>"
					].join("\n")));
					var ctx = document.getElementById(canvasId).getContext('2d');
					window.myLine = new Chart(ctx, chart.config);
				});
			});
		};
	</script>
</body>

</html>
