<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Corona-Charts</title>
	<link rel="stylesheet" href="https://bootswatch.com/4/cyborg/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
	
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body class="container">
        <a class="github-fork-ribbon" href="https://github.com/aweisser/corona-charts" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
	<div class="jumbotron">
		<h3>Do you want to visit another country but you can't really assess the Corona situation there?</h3>
        <p class="lead">
			The daily news mostly talk about absolute numbers of confirmed Covid-19 infections, 
			which does not tell you anything about the current situation in the different countries.
			Ok. 500k infections in the United States would be as bad as 500k infections in Luxembourg. 
			But if you're planning to visit Luxembourg, it'd be much more likely that you get infected than in the US,
			because 500k infections would mean, that almost every citizen of Luxembourg would be infected.
			It's about population or even population density, isn't it?
		</p>
		<p class="lead">
			In addition, the reported infections of a country must always be considered in relation to the number of tests performed.
			If a country has very few confirmed cases but does apply only very few tests as well, than you can expect that a lot more people are infected than confirmed.
		</p>
		<p class="lead">
			I think you can kind of assess the Corona situation in your own country. 
			In relation to that you can then judge the situation in other countries. 
			But that presupposes that the figures are comparable. You should avoid comparing apples with oranges.
			So let's try to get to something comparable!
        </p>
        <hr>
		<p>
			The following charts are based on live data from <a href="https://github.com/owid/covid-19-data">https://github.com/owid/covid-19-data</a>
			and <a href="https://github.com/pomber/covid19">https://github.com/pomber/covid19</a>, which in turn sources <a href="https://coronavirus.jhu.edu/map.html">jhu.edu</a>.
		</p>
        <p></p>
	</div>
	<script>
		const COLORS = [
	      'rgb(75, 192, 192)', // green
	      'rgb(255, 159, 64)', // orange
	      'rgb(201, 203, 207)', // grey
	      'rgb(54, 162, 235)', // blue
	      'rgb(255, 99, 132)', // red
	      'rgb(153, 102, 255)', // purple
	      'rgb(255, 205, 86)', // yellow
		];
		const charts = [
			{ 
				header: "Let's start with the absolute numbers.",
				title: 'Corona Infections absolute',
				getValue: function(dayData) { return dayData.total_cases; },
				config: {},
				text: "This tells you nothing. The different countries are not comparable. It's obvious that some big countries like USA and India have much more cases than the small European countries.", 
			},
			{ 
				header: "Let's normalize those numbers. As if every country had the same population.",
				title: 'Corona infections per 100k citizens',
				getValue: function(dayData, countryData) { return dayData.total_cases/countryData.population*100000; },
				config: {},
				text: "Now the countries are somehow comparable. But it doesn't show you the current situation.",
			},
			{ 
				header: "Ok. Now let's see how many people are currently infected in the different countries.",
				title: 'Running Corona infections per 100k citizens', 
				getValue: function(dayData, countryData, index) {
					var running = dayData.total_cases - dayData.total_recovered - dayData.total_deaths;
					return running/countryData.population*100000;
				},
				config: {},
				text: "This is even better because this reflects the current situation."
			},
			{ 
				header: "Let's see how this changes when we normalize the numbers to the population density.", 
				title: "Running Corona infections per square kilometer", 				
				getValue: function(dayData, countryData) {
					var running = dayData.total_cases - dayData.total_recovered - dayData.total_deaths;
					return running/countryData.population * countryData.population_density;
				},
				config: {},
				text: "This describes an average square kilometer. So don't take this as absolute numbers. " + 
				"It should be clear that the numbers in a city are much higher than on the countryside. " +
				"But if you compare similar regions of two countries this graph reflects the correct relation.",
			},
			{ 
				header: "But how reliable are those numbers above? The Corona test policies of the countries are very different." +
				"If only a few tests are applied than the number of running infections is not very reliable. " +
				"Let's try to fix this. Let's say every country would apply the same number of tests in relation to their population. ",
				title: 'Running Corona infections per square kilometer in relation to new tests (smoothed)', 
				getValue: function(dayData, countryData) {
					var running = dayData.total_cases - dayData.total_recovered - dayData.total_deaths;
					return (running/countryData.population * countryData.population_density)/dayData.new_tests_smoothed;
				},
				config: {},
				text: "Unfortunately the number of new tests is not consitently reported by the different countries. So the graphs are not that smooth.",
			},
		];
		const configTemplate = {
			type: 'line',
			data: {
				labels: [],
				datasets: []
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: '',
					fontSize: 18,
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true,
				},
				scales: {
					x: {
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Month',
						}
					},
					y: {
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value',
						}
					}
				}
			}
		};
		var covidWorldData = [];

		var clone = function(obj) {
			return JSON.parse(JSON.stringify(obj));
		};

		var initConfigs = function() {
			charts.forEach(function(chart) {
					var cfg = clone(configTemplate);
					cfg.options.title.text = chart.title;
					chart.config = cfg;
			});	
			// Get days from the first country (examplary for all other countries)
			covidWorldData[0].data.forEach(function(day) {
				charts.forEach(function(chart, index) {
					chart.config.data.labels.push(day.date);
				});
			});
		};

		var addCountry = function(countryData, color) {
			var name = countryData.location;
			charts.forEach(function(chart, index) {
				var ds = {
					label: name,
					backgroundColor: color,
					borderColor: color,
					data: [],
					fill: false,
				};
				countryData.data.forEach(function(dayData, index) {
					ds.data.push(chart.getValue(dayData, countryData, index));
				});
				chart.config.data.datasets.push(ds);
			});
		};

		window.onload = function() {
			$.getJSON('https://raw.githubusercontent.com/aweisser/corona-charts/master/data.json',
			function(owidCovidJson) {
				covidWorldData = owidCovidJson;
				initConfigs();
				covidWorldData.forEach(function(countryData, index) {
					addCountry(countryData, COLORS[index]);
				});

				charts.forEach(function(chart, index) {
					var canvasId = "canvas"+index;
					$("body").append($([
						"<div class='card mt-3'>",
						"	<div class='card-header'>",
						"		"+chart.header,
						"	</div>",
						"	<div class='card-body'>",
						"		<div style='width:100%;'>",
						"			<canvas id='"+canvasId+"'></canvas>",
						"		</div>",
						"		<p/>",
						"		<p class='card-text'>",
						"			"+chart.text || '',
						"		</p>",
						"	</div>",
						"</div>",
						"<br>",
					].join("\n")));
					var ctx = document.getElementById(canvasId).getContext('2d');
					window.myLine = new Chart(ctx, chart.config);
				});
			});
		};
	</script>
</body>

</html>
